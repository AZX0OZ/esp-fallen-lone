-- === ANTI-TAMPER DETECTOR ===
-- Запусти ПЕРВЫМ, до тампера

local isTampered = false
local reasons = {}

-- Снимаем fingerprints оригинальных функций
local originals = {
    print         = clonefunction(print),
    warn          = clonefunction(warn),
    require       = clonefunction(require),
    loadstring    = clonefunction(loadstring),
    getfenv       = clonefunction(getfenv),
    setfenv       = clonefunction(setfenv),
    pcall         = clonefunction(pcall),
    xpcall        = clonefunction(xpcall),
    tostring      = clonefunction(tostring),
    tonumber      = clonefunction(tonumber),
    rawget        = clonefunction(rawget),
    rawset        = clonefunction(rawset),
}

-- Сохраняем identity (адреса) функций
local identities = {}
for name, func in pairs(originals) do
    identities[name] = tostring(func)
end

-- Сохраняем метатаблицу game
local mt = getrawmetatable(game)
local orig_index    = clonefunction(mt.__index)
local orig_newindex = rawget(mt, "__newindex")
local orig_namecall = rawget(mt, "__namecall")

local origIndexAddr    = tostring(orig_index)
local origNamecallAddr = tostring(orig_namecall)

-- Функция проверки
local function runChecks()
    -- 1. Проверяем глобальные функции
    local env = getfenv(0)
    for name, originalFunc in pairs(originals) do
        local current = rawget(env, name) or _G[name]
        if current and tostring(current) ~= identities[name] then
            isTampered = true
            table.insert(reasons, string.format("Функция подменена: %s (было %s, стало %s)", name, identities[name], tostring(current)))
        end
    end

    -- 2. Проверяем __index метатаблицы game
    local newMt = getrawmetatable(game)
    local newIndex = rawget(newMt, "__index")
    if tostring(newIndex) ~= origIndexAddr then
        isTampered = true
        table.insert(reasons, string.format("game.__index подменён (было %s, стало %s)", origIndexAddr, tostring(newIndex)))
    end

    -- 3. Проверяем __namecall
    local newNamecall = rawget(newMt, "__namecall")
    if tostring(newNamecall) ~= origNamecallAddr then
        isTampered = true
        table.insert(reasons, string.format("game.__namecall подменён (было %s, стало %s)", origNamecallAddr, tostring(newNamecall)))
    end

    -- 4. Проверяем hookfunction через checkcaller (если доступно)
    if checkcaller then
        local ok = pcall(function()
            local dummy = function() end
            hookfunction(dummy, function() end)
            -- если hookfunction не бросает ошибку на защищённую функцию — подозрительно
        end)
    end

    -- 5. Проверяем getgc на наличие подозрительных замыканий
    if getgc then
        for _, obj in ipairs(getgc(true)) do
            if type(obj) == "table" then
                local s = rawget(obj, "__tamper_marker")
                if s == true then
                    isTampered = true
                    table.insert(reasons, "Найден __tamper_marker в getgc() — тампер активен")
                end
            end
        end
    end
end

-- Запускаем
runChecks()

-- Вывод результата
if isTampered then
    warn("╔══════════════════════════════════╗")
    warn("║   ⚠️  ТАМПЕР ОБНАРУЖЕН!          ║")
    warn("╚══════════════════════════════════╝")
    for i, reason in ipairs(reasons) do
        warn(string.format("  [%d] %s", i, reason))
    end
else
    print("╔══════════════════════════════════╗")
    print("║   ✅ ТАМПЕР НЕ ОБНАРУЖЕН        ║")
    print("╚══════════════════════════════════╝")
    print("  Все функции и метатаблицы в норме.")
end

-- Мониторинг в реальном времени
task.spawn(function()
    while true do
        task.wait(3)
        isTampered = false
        reasons = {}
        runChecks()
        if isTampered then
            warn("[AntiTamper] ⚠️ Изменение обнаружено в реальном времени!")
            for _, r in ipairs(reasons) do
                warn("  → " .. r)
            end
        end
    end
end)
