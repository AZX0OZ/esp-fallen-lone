-- === ANTI-TAMPER DETECTOR v2 ===
-- Снимаем fingerprint ПОСЛЕ загрузки (экзекютор уже всё похукал)

local isTampered = false
local reasons = {}

-- Ждём пока экзекютор завершит свои хуки
task.wait(0.1)

-- Снимаем fingerprint метатаблицы СЕЙЧАС (базовая линия)
local mt = getrawmetatable(game)
local origIndexAddr    = tostring(rawget(mt, "__index"))
local origNamecallAddr = tostring(rawget(mt, "__namecall"))
local origNewIndexAddr = tostring(rawget(mt, "__newindex"))

-- Снимаем fingerprint глобальных функций
local env = getfenv(0)
local originals = {}
local identities = {}

local watchList = {
    "print", "warn", "error",
    "require", "loadstring",
    "pcall", "xpcall",
    "getfenv", "setfenv",
    "tostring", "tonumber",
    "rawget", "rawset",
}

for _, name in ipairs(watchList) do
    local f = rawget(env, name) or _G[name]
    if f then
        originals[name]   = clonefunction(f)
        identities[name]  = tostring(f)
    end
end

print(string.format("[AntiTamper] Базовая линия установлена | __index: %s", origIndexAddr))

-- ===================== ПРОВЕРКИ =====================

local function runChecks()
    isTampered = false
    reasons    = {}

    -- 1. Глобальные функции
    for _, name in ipairs(watchList) do
        local current = rawget(env, name) or _G[name]
        if current and identities[name] and tostring(current) ~= identities[name] then
            isTampered = true
            table.insert(reasons, string.format(
                "Функция подменена: %s (было %s → стало %s)",
                name, identities[name], tostring(current)
            ))
        end
    end

    -- 2. Метатаблица game (сравниваем с нашей базовой линией)
    local curMt = getrawmetatable(game)

    local curIndex    = tostring(rawget(curMt, "__index"))
    local curNamecall = tostring(rawget(curMt, "__namecall"))
    local curNewIndex = tostring(rawget(curMt, "__newindex"))

    if curIndex ~= origIndexAddr then
        isTampered = true
        table.insert(reasons, string.format(
            "game.__index изменён после старта\n  было: %s\n  стало: %s",
            origIndexAddr, curIndex
        ))
    end

    if curNamecall ~= origNamecallAddr then
        isTampered = true
        table.insert(reasons, string.format(
            "game.__namecall изменён после старта\n  было: %s\n  стало: %s",
            origNamecallAddr, curNamecall
        ))
    end

    if curNewIndex ~= origNewIndexAddr then
        isTampered = true
        table.insert(reasons, string.format(
            "game.__newindex изменён после старта\n  было: %s\n  стало: %s",
            origNewIndexAddr, curNewIndex
        ))
    end

    -- 3. getgc маркер
    if getgc then
        for _, obj in ipairs(getgc(true)) do
            if type(obj) == "table" then
                if rawget(obj, "__tamper_marker") == true then
                    isTampered = true
                    table.insert(reasons, "getgc: найден __tamper_marker в памяти")
                end
            end
        end
    end

    -- 4. Проверка hookfunction на наших клонах
    if hookfunction and islclosure then
        for _, name in ipairs(watchList) do
            local f = rawget(env, name) or _G[name]
            if f and islclosure(f) then
                -- если функция lua-closure и адрес изменился — хукнута
                if tostring(f) ~= identities[name] then
                    isTampered = true
                    table.insert(reasons, string.format(
                        "hookfunction детект: %s", name
                    ))
                end
            end
        end
    end
end

-- ===================== ВЫВОД =====================

local function printResult(realtime)
    local prefix = realtime and "[AntiTamper RT]" or "[AntiTamper]"
    if isTampered then
        warn(prefix .. " ╔══════════════════════════════════╗")
        warn(prefix .. " ║   ⚠️  ТАМПЕР ОБНАРУЖЕН!          ║")
        warn(prefix .. " ╚══════════════════════════════════╝")
        for i, r in ipairs(reasons) do
            warn(string.format("%s   [%d] %s", prefix, i, r))
        end
    else
        if realtime then return end -- не спамим в консоль если всё чисто
        print(prefix .. " ╔══════════════════════════════════╗")
        print(prefix .. " ║   ✅ ТАМПЕР НЕ ОБНАРУЖЕН        ║")
        print(prefix .. " ╚══════════════════════════════════╝")
        print(prefix .. "   Все функции и метатаблицы в норме.")
    end
end

-- Первичная проверка
runChecks()
printResult(false)

-- Мониторинг каждые 3 сек
task.spawn(function()
    while true do
        task.wait(3)
        runChecks()
        printResult(true)
    end
end)
